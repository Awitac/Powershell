# Part 1: Retrieve SSL certificate bindings and save the output to a file
# Get the bindings
$bindings = netsh http show sslcert

# Display the list of bindings
Write-Host "List of bindings:"
for ($i = 0; $i -lt $bindings.Count; $i++) {
    Write-Host "$($bindings[$i].Trim())"
}

# Save the list of bindings to a text file
$bindings | Out-File -FilePath "C:\outputSSL.txt"

# Open the file in a new window
Invoke-Item "C:\outputSSL.txt"


# Part 2: Add a new SSL certificate binding
# Prompt user for input
$validThumbprint = $false
while (-not $validThumbprint) {
    try {
        Write-Host -NoNewline -ForegroundColor Yellow "Enter the Thumbprint of the Certificate: "
        $certificateThumbprint = Read-Host
        if ($certificateThumbprint -match '^[0-9a-fA-F]{40}$') {
            $validThumbprint = $true
        } else {
            throw "Invalid certificate thumbprint format: Thumbprint should be a 40-character hexadecimal string."
        }
    } catch {
        Write-Host "Error: $_" -ForegroundColor Red
    }
}

$validPort = $false
while (-not $validPort) {
    try {
        Write-Host -NoNewline -ForegroundColor Yellow "Enter the Port number (1-65535): "
        $port = Read-Host
        $port = [int]$port
        if ($port -ge 1 -and $port -le 65535) {
            if (-not (netsh http show sslcert | Where-Object { $_ -match "IP:port\s+: 0.0.0.0:$port" })) {
                $validPort = $true
            } else {
                throw "Port $port is already in use in a certificate binding"
            }
        } else {
            throw "Port number must be between 1 and 65535"
        }
    } catch {
        Write-Host "Error: $_" -ForegroundColor Red
    }
}

$validAppId = $false
while (-not $validAppId) {
    try {
        Write-Host -NoNewline -ForegroundColor Yellow "Enter the Application ID: "
        $applicationId = Read-Host
        if ($applicationId -match '^(\{){1}[0-9a-fA-F]{8}(\-){1}[0-9a-fA-F]{4}(\-){1}[0-9a-fA-F]{4}(\-){1}[0-9a-fA-F]{4}(\-){1}[0-9a-fA-F]{12}(\}){1}$') {
            [guid]$applicationId | Out-Null
            $validAppId = $true
        } else {
            throw "Invalid Application ID format: ID should be a GUID in the format {xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx}."
        }
    } catch {
        Write-Host "Error: $_" -ForegroundColor Red
    }
}

try {
    netsh http add sslcert ipport=0.0.0.0:$port certhash=$certificateThumbprint appid=$applicationId clientcertnegotiation=disable
    
    # Display the newly added binding
    $newBinding = netsh http show sslcert ipport=0.0.0.0:$port
    for ($i = 0; $i -lt $newBinding.Count; $i++) {
        Write-Host "$($newBinding[$i].Trim())"
    }
} catch {
    Write-Host "Error: $_" -ForegroundColor Red
}

Start-Sleep -Seconds 2


# Part 3: Delete the output file
if (Test-Path "C:\outputSSL.txt") {
    try {
        Remove-Item -Path "C:\outputSSL.txt" -Force
        Write-Host "Output file deleted." -ForegroundColor Yellow
    } catch {
        Write-Host "Error: $_"
    }
} else {
    Write-Host "Output file not found." -ForegroundColor Yellow
}
